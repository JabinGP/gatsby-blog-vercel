<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.e12c7c9c885ec3ebdd07.css" data-identity="gatsby-global-css">/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{-webkit-text-size-adjust:100%;line-height:1.15}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}[hidden],template{display:none}</style><meta name="generator" content="Gatsby 4.4.0"/><link as="script" rel="preload" href="/webpack-runtime-11cd8a660dee81b33a6d.js"/><link as="script" rel="preload" href="/framework-69325bf178eabe561408.js"/><link as="script" rel="preload" href="/app-83ce6fd2f1ccc517e165.js"/><link as="script" rel="preload" href="/46cc0ad690e07bdb83aca0e2e42f847dc2691093-5913af22e5b378b2ad63.js"/><link as="script" rel="preload" href="/component---src-pages-post-js-89ead2517795a9cdec6e.js"/><link as="fetch" rel="preload" href="/page-data/posts/code/node-koa2-session-login/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="sc-dkPtRN kgstGl"><div class="sc-hKwDye cUWynP"><h1>Node.js的Koa2中如何使用Session完成登录功能？</h1><h3>2020-12-08 13:08</h3></div><div id="stylemd" class="sc-bdvvtL fnZpqS"><blockquote><p>项目要用到登录注册，就需要使用到Cookie和Session来保持登录状态，于是就简单研究了一下</p></blockquote><h3>Cookie和Session的工作原理</h3><p>前面已经专门发过一篇帖子记录Cookie和Session的工作原理了，不明白的小伙伴可以看看<a href="https://segmentfault.com/a/1190000019065025">Cookie、Session是如何保持登录状态的？</a>。</p><h3>使用Koa的Session中间件</h3><p>Koa是一个简洁的框架，把许多小功能都拆分成了中间件，用一个洋葱模型保证了中间件丰富的可拓展性，我们要使用Session来保持登录状态，就需要引用Session中间件。</p><h3>安装Koa-Session中间件</h3><div class="gatsby-highlight" data-language="cmd"><pre class="prism-code language-cmd"><div class="token-line" style="color:#000000"><span class="token plain">npm install koa-session --save</span></div></pre></div><p>如果需要使用TypeScript进行开发，则需要引入对应的TS类型声明</p><div class="gatsby-highlight" data-language="cmd"><pre class="prism-code language-cmd"><div class="token-line" style="color:#000000"><span class="token plain">npm install @types/koa-session --save</span></div></pre></div><h3>配置Session</h3><p>Koa-Session需要做一些配置：</p><div class="gatsby-highlight" data-language="JavaScript"><pre class="prism-code language-JavaScript"><div class="token-line" style="color:#000000"><span class="token plain">const session_signed_key = [&quot;some secret hurr&quot;];  // 这个是配合signed属性的签名key</span></div><div class="token-line" style="color:#000000"><span class="token plain">const session_config = {</span></div><div class="token-line" style="color:#000000"><span class="token plain">    key: &#x27;koa:sess&#x27;, /**  cookie的key。 (默认是 koa:sess) */</span></div><div class="token-line" style="color:#000000"><span class="token plain">    maxAge: 4000,   /**  session 过期时间，以毫秒ms为单位计算 。*/</span></div><div class="token-line" style="color:#000000"><span class="token plain">    autoCommit: true, /** 自动提交到响应头。(默认是 true) */</span></div><div class="token-line" style="color:#000000"><span class="token plain">    overwrite: true, /** 是否允许重写 。(默认是 true) */</span></div><div class="token-line" style="color:#000000"><span class="token plain">    httpOnly: true, /** 是否设置HttpOnly，如果在Cookie中设置了&quot;HttpOnly&quot;属性，那么通过程序(JS脚本、Applet等)将无法读取到Cookie信息，这样能有效的防止XSS攻击。  (默认 true) */</span></div><div class="token-line" style="color:#000000"><span class="token plain">    signed: true, /** 是否签名。(默认是 true) */</span></div><div class="token-line" style="color:#000000"><span class="token plain">    rolling: true, /** 是否每次响应时刷新Session的有效期。(默认是 false) */</span></div><div class="token-line" style="color:#000000"><span class="token plain">    renew: false, /** 是否在Session快过期时刷新Session的有效期。(默认是 false) */</span></div><div class="token-line" style="color:#000000"><span class="token plain">};</span></div></pre></div><p>我们需要关注这几个配置：</p><ul><li>renew rolling
这两个都可以在用户访问的过程中刷新有效期，不至于让用户访问过程中Session过期成为未登录状态</li><li>signed
这个是对客户端Cookie的签名，也就是用一个特点的字符加密，保证客户端Cookie不会被伪造出来</li><li>httpOnly
打开这个使得通过程序(JS脚本、Applet等)无法读取Cookie，大大提高了安全性</li><li>maxAge
以ms为单位的过期时间</li></ul><h3>简单的使用</h3><p>首先理一下思路</p><ol><li>判断访问者的Session有没有过登录记录属性</li><li>如果有且值为true，则为已登录，否则为未登录</li><li>如果为已登录，则不执行判断，直接返回已登录，如果为未登录，则执行下一步登录验证</li><li>如果验证成功，则返回的登录成功，并且在它的session中记下登录属性为true，如果验证失败，则返回登录失败。</li></ol><blockquote><p>为了测试方便，以下用Get请求和一个固定的账号密码代替数据库查询，实际开发应该使用POST和数据库比对。同时为了测试方便，将过期时间设置为4000ms，便于快速看到Cookies过期，实际开发应该设置长一些，比如几小时甚至几天，取决于业务需求。</p></blockquote><div class="gatsby-highlight" data-language="JavaScript"><pre class="prism-code language-JavaScript"><div class="token-line" style="color:#000000"><span class="token plain">const Koa = require(&#x27;koa&#x27;);                               // 导入Koa</span></div><div class="token-line" style="color:#000000"><span class="token plain">const Koa_Session = require(&#x27;koa-session&#x27;);   // 导入koa-session     </span></div><div class="token-line" style="color:#000000"><span class="token plain">// 配置</span></div><div class="token-line" style="color:#000000"><span class="token plain">const session_signed_key = [&quot;some secret hurr&quot;];  // 这个是配合signed属性的签名key</span></div><div class="token-line" style="color:#000000"><span class="token plain">const session_config = {</span></div><div class="token-line" style="color:#000000"><span class="token plain">    key: &#x27;koa:sess&#x27;, /**  cookie的key。 (默认是 koa:sess) */</span></div><div class="token-line" style="color:#000000"><span class="token plain">    maxAge: 4000,   /**  session 过期时间，以毫秒ms为单位计算 。*/</span></div><div class="token-line" style="color:#000000"><span class="token plain">    autoCommit: true, /** 自动提交到响应头。(默认是 true) */</span></div><div class="token-line" style="color:#000000"><span class="token plain">    overwrite: true, /** 是否允许重写 。(默认是 true) */</span></div><div class="token-line" style="color:#000000"><span class="token plain">    httpOnly: true, /** 是否设置HttpOnly，如果在Cookie中设置了&quot;HttpOnly&quot;属性，那么通过程序(JS脚本、Applet等)将无法读取到Cookie信息，这样能有效的防止XSS攻击。  (默认 true) */</span></div><div class="token-line" style="color:#000000"><span class="token plain">    signed: true, /** 是否签名。(默认是 true) */</span></div><div class="token-line" style="color:#000000"><span class="token plain">    rolling: true, /** 是否每次响应时刷新Session的有效期。(默认是 false) */</span></div><div class="token-line" style="color:#000000"><span class="token plain">    renew: false, /** 是否在Session快过期时刷新Session的有效期。(默认是 false) */</span></div><div class="token-line" style="color:#000000"><span class="token plain">};</span></div><div class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#000000"><span class="token plain">// 实例化</span></div><div class="token-line" style="color:#000000"><span class="token plain">const app = new Koa();</span></div><div class="token-line" style="color:#000000"><span class="token plain">const session = Koa_Session(session_config, app)</span></div><div class="token-line" style="color:#000000"><span class="token plain">app.keys = session_signed_key;</span></div><div class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#000000"><span class="token plain">// 使用中间件，注意有先后顺序</span></div><div class="token-line" style="color:#000000"><span class="token plain">app.use(session);</span></div><div class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#000000"><span class="token plain">app.use(ctx =&gt; {</span></div><div class="token-line" style="color:#000000"><span class="token plain">    const databaseUserName = &quot;testSession&quot;;</span></div><div class="token-line" style="color:#000000"><span class="token plain">    const databaseUserPasswd = &quot;noDatabaseTest&quot;;</span></div><div class="token-line" style="color:#000000"><span class="token plain">    // 对/favicon.ico网站图标请求忽略</span></div><div class="token-line" style="color:#000000"><span class="token plain">    if (ctx.path === &#x27;/favicon.ico&#x27;) return;</span></div><div class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#000000"><span class="token plain">    if (!ctx.session.logged) {  // 如果登录属性为undefined或者false，对应未登录和登录失败</span></div><div class="token-line" style="color:#000000"><span class="token plain">        // 设置登录属性为false</span></div><div class="token-line" style="color:#000000"><span class="token plain">        ctx.session.logged = false;</span></div><div class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#000000"><span class="token plain">        // 取请求url解析后的参数对象，方便比对</span></div><div class="token-line" style="color:#000000"><span class="token plain">        // 如?nickname=post修改&amp;passwd=123解析为{nickname:&quot;post修改&quot;,passwd:&quot;123&quot;}</span></div><div class="token-line" style="color:#000000"><span class="token plain">        let query = ctx.request.query;</span></div><div class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#000000"><span class="token plain">        // 判断用户名密码是否为空</span></div><div class="token-line" style="color:#000000"><span class="token plain">        if (query.nickname &amp;&amp; query.passwd) {</span></div><div class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#000000"><span class="token plain">            // 比对并分情况返回结果  </span></div><div class="token-line" style="color:#000000"><span class="token plain">            if (databaseUserName == query.nickname) {  // 如果存在该用户名</span></div><div class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#000000"><span class="token plain">                // 进行密码比对并返回结果 </span></div><div class="token-line" style="color:#000000"><span class="token plain">                ctx.body = (databaseUserPasswd == query.passwd) ? &quot;登录成功&quot; : &quot;用户名或密码错误&quot;;</span></div><div class="token-line" style="color:#000000"><span class="token plain">                ctx.session.logged = true;</span></div><div class="token-line" style="color:#000000"><span class="token plain">            } else {                    // 如果不存在该用户名                                           //  如果用户名不存在</span></div><div class="token-line" style="color:#000000"><span class="token plain">                ctx.body = &quot;用户名不存在&quot;;</span></div><div class="token-line" style="color:#000000"><span class="token plain">            }</span></div><div class="token-line" style="color:#000000"><span class="token plain">        } else {</span></div><div class="token-line" style="color:#000000"><span class="token plain">            ctx.body = &quot;用户名密码不能为空&quot;;</span></div><div class="token-line" style="color:#000000"><span class="token plain">        }</span></div><div class="token-line" style="color:#000000"><span class="token plain">    } else {</span></div><div class="token-line" style="color:#000000"><span class="token plain">        ctx.body = &quot;已登录&quot;;</span></div><div class="token-line" style="color:#000000"><span class="token plain">    }</span></div><div class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#000000"><span class="token plain">}</span></div><div class="token-line" style="color:#000000"><span class="token plain">);</span></div><div class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#000000"><span class="token plain">app.listen(3000);</span></div><div class="token-line" style="color:#000000"><span class="token plain">console.log(&quot;Koa运行在：http://127.0.0.1:3000&quot;);</span></div></pre></div><p>运行一下，控制台输出：</p><div class="gatsby-highlight" data-language="cmd"><pre class="prism-code language-cmd"><div class="token-line" style="color:#000000"><span class="token plain">Koa运行在：http://127.0.0.1:3000</span></div></pre></div><p>访问<a href="http://127.0.0.1:3000">http://127.0.0.1:3000</a>，可以看到我们没有填写登录参数，然后返回了用户名密码不能空，并且按下F12，点击Cookies再点击<a href="http://127.0.0.1:3000">http://127.0.0.1:3000</a>，看到了我们的SessionId被记录到了Cookies中，说明Session生效了。
<img src="https://upload-images.jianshu.io/upload_images/14225973-8ae8fb28dcfe78a5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="1"/></p><p>我们静置一会但不刷新页面，再点击Cookies后重新点击，<a href="http://127.0.0.1:3000">http://127.0.0.1:3000</a>（刷新Cookies显示），发现我们的SessionId不见了，说明我们的过期时间也生效了
<img src="https://upload-images.jianshu.io/upload_images/14225973-ecbf3753b37436c5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="2"/></p><p>我将Cookies的数据截详细一点就是这样的，可以看到有个过期时间：
<img src="https://upload-images.jianshu.io/upload_images/14225973-422c47b819d5c7cf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="3"/></p><p>我们再访问<a href="http://127.0.0.1:3000/?nickname=123">http://127.0.0.1:3000/?nickname=123</a>和<a href="http://127.0.0.1:3000/?passwd=123">http://127.0.0.1:3000/?passwd=123</a>，都输出了
<img src="https://upload-images.jianshu.io/upload_images/14225973-618d9f63eaf7d2cc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="4"/></p><p>访问<a href="http://127.0.0.1:3000/?nickname=123&amp;&amp;passwd=123">http://127.0.0.1:3000/?nickname=123&amp;&amp;passwd=123</a>，输出
<img src="https://upload-images.jianshu.io/upload_images/14225973-04fc4fc688e30868.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="5"/></p><p>访问<a href="http://127.0.0.1:3000/?nickname=testSession&amp;&amp;passwd=123">http://127.0.0.1:3000/?nickname=testSession&amp;&amp;passwd=123</a>，输出
<img src="https://upload-images.jianshu.io/upload_images/14225973-236ee36413c040fd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="6"/></p><p>最后尝试正确的用户名密码<a href="http://127.0.0.1:3000/?nickname=testSession&amp;&amp;passwd=noDatabaseTest">http://127.0.0.1:3000/?nickname=testSession&amp;&amp;passwd=noDatabaseTest</a>
，输出<img src="https://upload-images.jianshu.io/upload_images/14225973-a67d3a9bdbc9b3ee.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="登录成功"/>
尝试再次访问<a href="http://127.0.0.1:3000/?nickname=testSession&amp;&amp;passwd=noDatabaseTest">http://127.0.0.1:3000/?nickname=testSession&amp;&amp;passwd=noDatabaseTest</a>
，输出</p><p><img src="https://upload-images.jianshu.io/upload_images/14225973-3fbd253861481a36.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="重复登录"/></p><p>在有效期限内访问别的页面<a href="http://127.0.0.1:3000/">http://127.0.0.1:3000/</a>，输出
<img src="https://upload-images.jianshu.io/upload_images/14225973-8783aac616ff79aa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="有效期内"/></p><p>有效期内不断刷新就能保持登录状态
<img src="https://upload-images.jianshu.io/upload_images/14225973-5152a1573021dfe8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="不断刷新"/></p><p>有效期内没有重新操作页面刷新状态就会自然过期
<img src="https://upload-images.jianshu.io/upload_images/14225973-9853d8e5e14bf4df.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="过期"/></p></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/posts/code/node-koa2-session-login";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-71841f628f9c8d668040.js"],"app":["/app-83ce6fd2f1ccc517e165.js"],"component---src-pages-404-js":["/component---src-pages-404-js-46407eeca50ec9ed10bd.js"],"component---src-pages-index-js":["/component---src-pages-index-js-e7cb994314077869c2fc.js"],"component---src-pages-post-js":["/component---src-pages-post-js-89ead2517795a9cdec6e.js"],"component---src-pages-search-js":[]};/*]]>*/</script><script src="/polyfill-71841f628f9c8d668040.js" nomodule=""></script><script src="/component---src-pages-post-js-89ead2517795a9cdec6e.js" async=""></script><script src="/46cc0ad690e07bdb83aca0e2e42f847dc2691093-5913af22e5b378b2ad63.js" async=""></script><script src="/app-83ce6fd2f1ccc517e165.js" async=""></script><script src="/framework-69325bf178eabe561408.js" async=""></script><script src="/webpack-runtime-11cd8a660dee81b33a6d.js" async=""></script></body></html>