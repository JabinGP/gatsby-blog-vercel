<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.e12c7c9c885ec3ebdd07.css" data-identity="gatsby-global-css">/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{-webkit-text-size-adjust:100%;line-height:1.15}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}[hidden],template{display:none}</style><meta name="generator" content="Gatsby 4.4.0"/><link as="script" rel="preload" href="/webpack-runtime-97dd88bd1a8334b86a8b.js"/><link as="script" rel="preload" href="/framework-69325bf178eabe561408.js"/><link as="script" rel="preload" href="/app-83ce6fd2f1ccc517e165.js"/><link as="script" rel="preload" href="/46cc0ad690e07bdb83aca0e2e42f847dc2691093-57175e9be9b06b4bcea2.js"/><link as="script" rel="preload" href="/component---src-pages-post-js-89ead2517795a9cdec6e.js"/><link as="fetch" rel="preload" href="/page-data/posts/code/iris-chatroom-demo/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="sc-gsDKAQ bfoVMF"><div class="sc-dkPtRN bZTKrI"><h1>iris项目示例，基于AJAX的简易聊天室</h1><h3>2020-12-08 13:36</h3></div><div id="stylemd" class="sc-bdvvtL hlRsZa"><blockquote><p>项目地址<a href="https://github.com/JabinGP/demo-chatroom">https://github.com/JabinGP/demo-chatroom</a>，对你有帮助的话请多多star</p></blockquote><p>go+iris+jwt+mysql+gorm+viper，iris项目实战简易聊天室，登录、注册、私聊、群聊。</p><h2>项目启动</h2><div class="gatsby-highlight" data-language="cmd"><pre class="prism-code language-cmd"><div class="token-line" style="color:#000000"><span class="token plain">git clone https://github.com/JabinGP/demo-chatroom.git</span></div><div class="token-line" style="color:#000000"><span class="token plain">cd demo-chatroom</span></div><div class="token-line" style="color:#000000"><span class="token plain">// 复制config.toml.example 为 config.toml 并填写数据库信息，或者可选修改端口号</span></div><div class="token-line" style="color:#000000"><span class="token plain">go run demo-chatroom.go</span></div></pre></div><p>默认为8888端口，启动后访问<code>http://localhost:8888</code>即可，或者访问演示地址<code>http://mike.jabingp.cn:8888</code></p><h3>前端</h3><p>用了react，但是没用ui框架，很多的小细节上表现并不好，凑合着看吧，重点放在后端。</p><p>聊天框设置了窗口自动滚动到底端，但是api是react提供的，发现在许多浏览器上并不兼容，使用chrome浏览器可以解决这个问题。</p><p>注册后手动返回选择登陆，消息框里面的红色名称为公共发言，灰色名称为私聊发言、可以在红色的框里面指定接收者的名称，如果不指定的话，默认是公共发言，指定后只有对应的用户能看到信息。</p><p>蓝色框内显示自己的用户名，点击即直接退出登录。</p><h3>后端</h3><p>api格式基于restful设计，登录功能使用jwt完成，许多接口需要登录状态，请求的时候需要携带JWT，具体请看<a href="https://segmentfault.com/a/1190000021187448">golang iris的jwt实践</a>，另外便于测试，JWT签发有效时间只设置了20分钟，过期需要重新登录。</p><table><thead><tr><th>功能</th><th>请求方式</th><th>地址</th></tr></thead><tbody><tr><td>获取登录token</td><td>POST</td><td><a href="http://localhost:8888/v1/login">http://localhost:8888/v1/login</a></td></tr><tr><td>查找用户</td><td>GET</td><td><a href="http://localhost:8888/v1/user">http://localhost:8888/v1/user</a></td></tr><tr><td>注册</td><td>POST</td><td><a href="http://localhost:8888/v1/user">http://localhost:8888/v1/user</a></td></tr><tr><td>用户自己修改信息</td><td>PUT</td><td><a href="http://localhost:8888/v1/user">http://localhost:8888/v1/user</a></td></tr><tr><td>用户发送信息</td><td>POST</td><td><a href="http://localhost:8888/v1/message">http://localhost:8888/v1/message</a></td></tr><tr><td>用户获取信息</td><td>GET</td><td><a href="http://localhost:8888/v1/message">http://localhost:8888/v1/message</a></td></tr><tr><td>用户获取token信息</td><td>GET</td><td><a href="http://localhost:8888/v1/token/info">http://localhost:8888/v1/token/info</a></td></tr></tbody></table><p>详细请求参数可以在<a href="https://documenter.getpostman.com/view/7019042/SWECVaGy?version=latest">demo-chatroom的postman-api文档</a>里查看。</p><p>或者查看源码，请求参数在<code>model/reqo</code>里面查看，响应参数可以在<code>model/reso</code>里查看</p><h2>前言</h2><p>聊天功能AJAX不是最好的选择，WebSocket比较好，但是被要求使用了AJAX所以没有选择后者。</p><p>项目的前端比较简陋，因为只是作为demo使用。</p><p>英语不是很好，代码注释用英语只是因为懒得切换输入法。</p><p>第一次用go开发web项目，也是第一次用react写前端，由于前端没怎么注重项目结构（xjbx），就不放源码了，把项目编译后放在了assets文件夹下，可读性很差，但是可以和后端一起启动，不需要单独启动前端，比较方便查看效果。如果还有时间会考虑用原生写一个极简版的供大家参考原理。</p><p>第一次用ORM操作数据库，感觉好难用，我还是宁愿手写sql，好多想要的效果翻半天文档都找不到解决方案，后期有机会考虑用sqlx重构。</p><h2>项目来源</h2><p>最近对Go比较有兴趣，又接到任务编写一个简易聊天室，发现目前iris的项目实践比较少，只有一些HelloWorld级别的示例，于是决定用Go来做，然后开源出来供大互相参考借鉴，当然项目结构如何设计完全基于我有限的开发经验，对于不合理的地方，请给出你宝贵的意见。</p><h2>项目要点</h2><p>这个项目有如下要求</p><ol><li>基于AJAX</li><li>前端页面需要无刷新（自动更新数据）</li><li>登录功能</li><li>注册功能（要求用户有用户名、密码、性别、年龄、兴趣爱好）</li></ol><h2>实现思路</h2><h3>登陆功能</h3><p>登陆功能这次选用<code>JWT</code>来实现，<code>JWT</code>和<code>Session</code>各自的优劣就不再赘述。</p><h3>基于AJAX，且无刷新</h3><p>基于AJAX是所有前后端分离项目的必备，因此这个功能不过多讨论，这里重点在于无刷新，难点在哪？</p><h4>用户操作需求</h4><p>用户的操作逻辑是，在聊天室里面发送数据，然后数据就被发出去，聊天界面要显示出自己发送的数据，以及要实时更新别人发出来的数据。</p><h4>前端的操作逻辑</h4><p>前端和后端之间是通过AJAX来交流的，前端发送数据和后端发送数据可以表现为</p><ul><li>发送数据：前端将需要发送的数据以JSON格式携带在请求里，请求对于结构</li><li>获取数据：前端请求后台获取消息的接口，获取最新消息</li></ul><p>这里有什么问题？问就在前端永远只能主动发起请求，而后端永远只能接受请求。这意味着最新的消息永远无法实时地从后端主动发送给前端，最新的消息只能先存放在后端，然后等待前端发起请求，后端才能返回数据。</p><p>由于后端是没有能力主动推送消息给前端的，因此用户获取最新数据的解决方法是前端设置一个定时器<code>每隔一段比较短的时间就请求一次后台接口（轮询）</code>，这样就能不断更新数据。</p><h4>后端的操作逻辑</h4><p>前端已经确定使用AJAX定时轮询后台接口来获取最新数据，为了数据实时性，轮询间隔会<code>小于1s</code>，这样又会带来另个问题，后端在如此频繁的请求下，一定不能每次都将所有数据都传输出去，一是数据大小导致的网路传输效率、流量成本问题，二是数据大小导致的前端判断新数据的效率问题，那么后端每次必须都返回前端还没有接收过的数据，而问题在于--后端怎么知道前端已经接收了哪些信息？</p><p>这个就要利用到消息的<code>自增主键</code>，只需要前端每次请求的时候都携带上前端已经接收的<code>最后的消息的主键</code>，由于主键是不重复且自增的，我们可以很轻松的找出比该主键大的数据，也就是前端还没接收到的数据。</p><h2>项目技术栈</h2><ul><li><p>语言</p><ul><li>Golang</li><li>HTML</li><li>CSS</li><li>JavaScript</li></ul></li><li><p>框架</p><ul><li>Iris 后端框架</li><li>React 前端框架</li><li>Gorm 数据库ORM框架</li><li>Viper 多类型配置文件读取支持</li></ul></li><li><p>数据存储</p><ul><li>Mysql 经典数据库</li></ul></li><li><p>技术</p><ul><li>JWT 签发登陆令牌</li><li>AJAX 异步请求后端数据</li></ul></li></ul><h2>数据库设计结构</h2><blockquote><p>由于使用了Gorm数据库ORM框架，以下表都是自动生成的，自带了<code>xxxxxx_at</code>字段</p></blockquote><p>基于如上的需求，设计了<code>users</code>和<code>messages</code>两个表</p><h3>users</h3><p>关键字段</p><ul><li>id</li><li>username</li><li>passwd</li><li>gender</li><li>age</li><li>interest</li></ul><p>数据库表结构</p><table><thead><tr><th align="left">Field</th><th align="left">Type</th><th align="left">Null</th><th align="left">Key</th><th align="left">Default</th><th align="left">Extra</th></tr></thead><tbody><tr><td align="left">id</td><td align="left">int<!-- -->(<!-- -->10<!-- -->)<!-- --> unsigned</td><td align="left">NO</td><td align="left">PRI</td><td align="left">NULL</td><td align="left">auto<!-- -->_<!-- -->increment</td></tr><tr><td align="left">created<!-- -->_<!-- -->at</td><td align="left">timestamp</td><td align="left">YES</td><td align="left"></td><td align="left">NULL</td><td align="left"></td></tr><tr><td align="left">updated<!-- -->_<!-- -->at</td><td align="left">timestamp</td><td align="left">YES</td><td align="left"></td><td align="left">NULL</td><td align="left"></td></tr><tr><td align="left">deleted<!-- -->_<!-- -->at</td><td align="left">timestamp</td><td align="left">YES</td><td align="left">MUL</td><td align="left">NULL</td><td align="left"></td></tr><tr><td align="left">username</td><td align="left">varchar<!-- -->(<!-- -->255<!-- -->)</td><td align="left">YES</td><td align="left"></td><td align="left">NULL</td><td align="left"></td></tr><tr><td align="left">passwd</td><td align="left">varchar<!-- -->(<!-- -->255<!-- -->)</td><td align="left">YES</td><td align="left"></td><td align="left">NULL</td><td align="left"></td></tr><tr><td align="left">gender</td><td align="left">bigint<!-- -->(<!-- -->20<!-- -->)</td><td align="left">YES</td><td align="left"></td><td align="left">NULL</td><td align="left"></td></tr><tr><td align="left">age</td><td align="left">bigint<!-- -->(<!-- -->20<!-- -->)</td><td align="left">YES</td><td align="left"></td><td align="left">NULL</td><td align="left"></td></tr><tr><td align="left">interest</td><td align="left">varchar<!-- -->(<!-- -->255<!-- -->)</td><td align="left">YES</td><td align="left"></td><td align="left">NULL</td><td align="left"></td></tr></tbody></table><h3>messages</h3><p>关键字段</p><ul><li>id</li><li>sender_id -&gt; 对应消息发送者</li><li>receiver_id -&gt; 对应消息接受者</li><li>content</li><li>send_time</li></ul><p>数据库表结构</p><table><thead><tr><th align="left">Field</th><th align="left">Type</th><th align="left">Null</th><th align="left">Key</th><th align="left">Default</th><th align="left">Extra</th></tr></thead><tbody><tr><td align="left">id</td><td align="left">int<!-- -->(<!-- -->10<!-- -->)<!-- --> unsigned</td><td align="left">NO</td><td align="left">PRI</td><td align="left">NULL</td><td align="left">auto<!-- -->_<!-- -->increment</td></tr><tr><td align="left">created<!-- -->_<!-- -->at</td><td align="left">timestamp</td><td align="left">YES</td><td align="left"></td><td align="left">NULL</td><td align="left"></td></tr><tr><td align="left">updated<!-- -->_<!-- -->at</td><td align="left">timestamp</td><td align="left">YES</td><td align="left"></td><td align="left">NULL</td><td align="left"></td></tr><tr><td align="left">deleted<!-- -->_<!-- -->at</td><td align="left">timestamp</td><td align="left">YES</td><td align="left">MUL</td><td align="left">NULL</td><td align="left"></td></tr><tr><td align="left">sender<!-- -->_<!-- -->id</td><td align="left">int<!-- -->(<!-- -->10<!-- -->)<!-- --> unsigned</td><td align="left">YES</td><td align="left"></td><td align="left">NULL</td><td align="left"></td></tr><tr><td align="left">receiver<!-- -->_<!-- -->id</td><td align="left">int<!-- -->(<!-- -->10<!-- -->)<!-- --> unsigned</td><td align="left">YES</td><td align="left"></td><td align="left">NULL</td><td align="left"></td></tr><tr><td align="left">content</td><td align="left">varchar<!-- -->(<!-- -->255<!-- -->)</td><td align="left">YES</td><td align="left"></td><td align="left">NULL</td><td align="left"></td></tr><tr><td align="left">send<!-- -->_<!-- -->time</td><td align="left">timestamp</td><td align="left">YES</td><td align="left"></td><td align="left">NULL</td><td align="left"></td></tr></tbody></table><h2>项目结构</h2><blockquote><p>以下结构出于个人经验，有不当之处请给出宝贵意见</p></blockquote><ul><li>route 路由层，负责将&quot;\xxx\xxx&quot;请求映射到对应的函数</li><li>middleware 中间件层，可以在执行函数前后进行拦截并处理，如登陆拦截</li><li>controller 控制层，存放与&quot;\xxx\xxx&quot;请求对应的函数，根据请求，调用业务层，并将数据进行格式封装返回</li><li>service 业务层，调用持久层完成业务逻辑</li><li>dao 持久层，可以理解为sql执行到函数执行的封装，由于使用了ORM，本项目没有dao层目录</li><li>database 提供数据库连接</li><li>model 定义一系列结构体<ul><li>pojo 业务逻辑实体，如User，Message</li><li>reqo 请求数据实体，对应controller中的每个方法</li><li>reso 响应数据实体，对应controller中的每个方法</li></ul></li><li>config 读取配置，并提供单实例的配置文件实体供外访问</li><li>tool 工具层</li><li>assets 静态资源目录，存放静态资源（前端文件）</li></ul><h3>pojo、reqo、reso都是什么</h3><ul><li><p>pojo</p><p>很好理解，就是数据库对应的实体，但不要求与数据库字段一一对应</p></li><li><p>reqo(request object)、reso(response object)</p><p>不同接口请求的时候，可以携带的参数以及响应的数据也不同，所以为每一个接口设计一个对应的请求实体和响应实体</p></li></ul><h3>controller、service、dao到底有什么区别</h3><blockquote><p>以下为个人理解</p></blockquote><ul><li><p>Controller</p><p>主要职责是，接受请求的请求参数，转换为reqo，进行简单的请求参数验证（我个人的定义与数据库无关的验证，如非空、非零），调用Service层的函数获取pojo结果，并将pojo结果转换封装为reso返回。</p></li><li><p>Service</p><p>主要职责是，对Dao层的接口进一步封装，提供通用的接口给Controller调用，返回数据可以是pojo，在Service内需要进行数据的验证，如（新增用户，校验用户名是否重复）。</p></li><li><p>Dao</p><p>这里基本上一个方法直接对应一条sql语句，不做任何的验证，认为接收到的数据是可靠的（已经经过了Controller和Service两层的参数验证了），返回数据可以是pojo。</p></li></ul><blockquote><p>项目地址<a href="https://github.com/JabinGP/demo-chatroom">https://github.com/JabinGP/demo-chatroom</a>，对你有帮助的话请多多star！</p></blockquote></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/posts/code/iris-chatroom-demo";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-71841f628f9c8d668040.js"],"app":["/app-83ce6fd2f1ccc517e165.js"],"component---src-pages-404-js":["/component---src-pages-404-js-46407eeca50ec9ed10bd.js"],"component---src-pages-index-js":["/component---src-pages-index-js-990038c5763b601e59d3.js"],"component---src-pages-post-js":["/component---src-pages-post-js-89ead2517795a9cdec6e.js"],"component---src-pages-search-js":[]};/*]]>*/</script><script src="/polyfill-71841f628f9c8d668040.js" nomodule=""></script><script src="/component---src-pages-post-js-89ead2517795a9cdec6e.js" async=""></script><script src="/46cc0ad690e07bdb83aca0e2e42f847dc2691093-57175e9be9b06b4bcea2.js" async=""></script><script src="/app-83ce6fd2f1ccc517e165.js" async=""></script><script src="/framework-69325bf178eabe561408.js" async=""></script><script src="/webpack-runtime-97dd88bd1a8334b86a8b.js" async=""></script></body></html>